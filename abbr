ABBR_SOURCE="$HOME"/.zsh_abbreviations

typeset -gA abbreviations

if [ -s "$ABBR_SOURCE" ]; then
  while read k v; do abbreviations[$k]="$v"; done < "$ABBR_SOURCE"
fi

function abbr() {
  abbreviations+=("$@")
  echo "$*" >> $ABBR_SOURCE
}

function expand_abbr() {
  local current_word="${LBUFFER/*[ ,;|&\n\t]/}"
  local expansion=${abbreviations[$current_word]}

  if [ $expansion ]; then
    local command_up_to_abbreviation="${LBUFFER%%$current_word}"
    LBUFFER="$command_up_to_abbreviation$expansion"
  fi
  zle self-insert
}

zle -N expand_abbr

bindkey " " expand_abbr
bindkey "^ " magic-space
bindkey -M isearch " " magic-space
bindkey -M isearch "^ " expand_abbr


